rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==========================================================================
    // Allowlist - Only these emails can use the app
    // ==========================================================================

    function isApprovedUser() {
      return request.auth.token.email in [
        // Add approved emails here:
        "asmundg@gmail.com"
      ];
    }

    // Devices authenticate with deviceId claim (no email)
    function isApprovedDevice() {
      return request.auth.token.deviceId != null;
    }

    // ==========================================================================
    // Helper Functions
    // ==========================================================================

    function isAuthenticated() {
      return request.auth != null && (isApprovedUser() || isApprovedDevice());
    }

    function getFamily(familyId) {
      return get(/databases/$(database)/documents/families/$(familyId)).data;
    }

    // Check if user is a member of the family (any role)
    function isMemberOf(familyId) {
      return isAuthenticated() &&
             request.auth.token.email in getFamily(familyId).members.keys();
    }

    // Check if user has specific role or higher
    function hasRole(familyId, role) {
      let family = getFamily(familyId);
      let email = request.auth.token.email;
      let memberRole = family.members[email];

      // Role hierarchy: owner > admin > viewer
      return isAuthenticated() &&
             email in family.members.keys() &&
             (role == 'viewer' ||
              (role == 'admin' && memberRole in ['admin', 'owner']) ||
              (role == 'owner' && memberRole == 'owner'));
    }

    // Check if user is the owner of the family
    function isOwnerOf(familyId) {
      return hasRole(familyId, 'owner');
    }

    // Check if user can manage (admin or owner)
    function canManage(familyId) {
      return hasRole(familyId, 'admin');
    }

    // Check if request has valid device token
    function isDevice(deviceId) {
      return isAuthenticated() &&
             request.auth.token.deviceId == deviceId;
    }

    // ==========================================================================
    // Families
    // ==========================================================================

    match /families/{familyId} {
      // Any member can read (uses resource.data directly for query compatibility)
      allow read: if isAuthenticated() &&
                     request.auth.token.email in resource.data.members.keys();

      // Anyone authenticated can create (they become owner)
      allow create: if isAuthenticated() &&
                       request.resource.data.ownerEmail == request.auth.token.email &&
                       request.auth.token.email in request.resource.data.members.keys() &&
                       request.resource.data.members[request.auth.token.email] == 'owner';

      // Only owner can update family settings
      // Admins can update but not change members
      allow update: if isOwnerOf(familyId) ||
                       (canManage(familyId) && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['members', 'ownerEmail']));

      // Only owner can delete
      allow delete: if isOwnerOf(familyId);
    }

    // ==========================================================================
    // Devices
    // ==========================================================================

    match /devices/{deviceId} {
      // Members can read, device can read itself
      allow read: if isMemberOf(resource.data.familyId) || isDevice(deviceId);

      // Admins can create devices
      allow create: if canManage(request.resource.data.familyId);

      // Admins can update, devices can update their own status
      allow update: if canManage(resource.data.familyId) ||
                       (isDevice(deviceId) && onlyUpdatingDeviceStatus());

      // Admins can delete
      allow delete: if canManage(resource.data.familyId);

      function onlyUpdatingDeviceStatus() {
        let allowed = ['currentApp', 'currentAppPackage', 'lastSeen', 'fcmToken'];
        return request.resource.data.diff(resource.data).affectedKeys().hasOnly(allowed);
      }
    }

    // ==========================================================================
    // Users (Children)
    // ==========================================================================

    match /users/{userId} {
      // Members can read
      allow read: if isMemberOf(resource.data.familyId);

      // Admins can create/delete
      allow create: if canManage(request.resource.data.familyId);
      allow delete: if canManage(resource.data.familyId);

      // Admins can update all, devices can only update time fields
      allow update: if canManage(resource.data.familyId) ||
                       (isAuthenticated() && onlyUpdatingTime());

      function onlyUpdatingTime() {
        let allowed = ['todayUsedMinutes', 'lastResetDate'];
        return request.resource.data.diff(resource.data).affectedKeys().hasOnly(allowed);
      }
    }

    // ==========================================================================
    // Whitelist
    // ==========================================================================

    match /whitelist/{itemId} {
      // Any authenticated user can read (devices need this)
      allow read: if isAuthenticated();

      // Admins can manage
      allow create: if canManage(request.resource.data.familyId);
      allow update, delete: if canManage(resource.data.familyId);
    }

    // ==========================================================================
    // Extension Requests
    // ==========================================================================

    match /extensionRequests/{requestId} {
      // Members can read, devices can read their own
      allow read: if isMemberOf(resource.data.familyId) || isAuthenticated();

      // Devices can create requests
      allow create: if isAuthenticated();

      // Admins can approve/deny, devices can mark as processed
      allow update: if canManage(resource.data.familyId) ||
                       (isAuthenticated() && onlyMarkingProcessed());

      // Admins can delete
      allow delete: if canManage(resource.data.familyId);

      function onlyMarkingProcessed() {
        return request.resource.data.status == 'processed' &&
               resource.data.status == 'approved';
      }
    }

    // ==========================================================================
    // Usage Logs
    // ==========================================================================

    match /usageLogs/{logId} {
      // Members can read
      allow read: if isMemberOf(resource.data.familyId);

      // Devices can create
      allow create: if isAuthenticated();

      // Logs are immutable
      allow update, delete: if false;
    }

    // ==========================================================================
    // Internal Collections (registration codes, alerts)
    // ==========================================================================

    match /_registrationCodes/{code} {
      // Only Cloud Functions access these
      allow read, write: if false;
    }

    match /_alerts/{alertId} {
      // Only Cloud Functions access these
      allow read, write: if false;
    }
  }
}
